# 친절한 SQL 튜닝
- 개발자를 위한 SQL 튜닝 입문서
- DB 프로그래밍에 어느정도 경험이 쌓였는데도 성능 문제를 스스로 해결하지 못해 늘 고민하는 사람을 위한 책

## 1. SQL 처리과정과 I/O
### 1.1 SQL 파싱과 최적화
- SQL은 기본적으로 구조적, 집합적, 선언적인 질의 언어
- 원하는 결과를 구조적, 집합적으로 선언하지만, 그 결과집합을 만드는 과정은 절차적 -> 프로시저 필요
- SQL 옵티마이저: 프로시저를 만들어내는 DBMS 내부 엔진
- SQL 최적화: DBMS 내부에서 프로시저를 작성하고 컴파일해서 실행 가능한 상태로 만드는 전 과정

#### 1.1.2 SQL 최적화
- SQL 실행하기 전 최적화 과정
  1. SQL 파싱
     - 사용자로부터 SQL을 전달받으면 가장 먼저 SQL 파서가 파싱을 진행
     - 파싱 트리 생성: SQL 문을 이루는 개별 구성 요소를 분석해서 파싱트리 생성
     - Syntax 체크: 문법적 오류가 없는지 확인
     - Semantic 체크: 의미상 오류가 없는지 확인
  2. SQL 최적화
     - 옵티마이저: 미리 수집한 시스템 및 오브젝트 통계정보를 바탕으로 다양한 실행 경로를 생성해서 비교한 후 가장 효율적인 하나를 선택
     - 데이터베이스 성능을 결정하는 가장 핵심적인 엔진
  3. 로우 소스 생성
     - 로우 소스 생성기: SQL 옵티마이저가 선택한 실행 경로를 실제 실행 가능한 코드 또는 프로시저 형태로 포맷팅하는 단계

#### 1.1.3 SQL 옵티마이저
- SQL 옵티마이저: 사용자가 원하는 작업을 가장 효율적으로 수행할 수 있는 최적의 데이터액세스 경로를 선택해주는 DBMS의 핵심 엔진
- 옵티마이저의 최적화 단계 
  1. 사용자로부터 전달받은 쿼리를 수행하는 데 후보군이 될만한 실행계획들을 찾아냄
  2. 데이터 딕셔너리에 미리 수집해 둔 오브젝트 통계 및 시스템 통계정보를 이용해 각 실행계획의 예상비용 산정
  3. 최저 비용을 나타내는 실행계획 선택

### 1.2 SQL 공유 및 재사용
#### 1.2.1 소프트 파싱 vs 하드 파싱
- 라이브러리 캐시
  - SQL 파싱, 최적화, 로우 소스 생성 과정을 거쳐 생성한 내부 프로시저를 반복 재사용할 수 있도록 캐싱해 두는 메모리 공간
  - SGA 구성요소 중 하나
  - ㄴ SGA(System Global Area): 서버 프로세스와 백그라운드 프로세스가 공통으로 액세스하는 데이터와 제어구조를 캐싱하는 메모리 공간
  - 필요한 이유
    - 데이터베이스에서 이루어지는 처리과정은 대부분 IO작업에 집중되지만, 하드 파싱은 CPU를 많이 소비하는 작업
    - 이렇게 생성한 내부 프로시저를 한 번만 사용하고 버린다면 비효율이므로 라이브러리 캐시가 필요
- 소프트 파싱 Soft parsing: 사용자가 SQL문을 전달하면 DBMS는 SQL을 파싱한 후 해당 SQL이 라이브러리 캐시에 존재해서 곧바로 실행 단계로 넘어가는 것
- 하드 파싱 Hard parsing: 사용자가 SQL문을 전달하면 DBMS는 SQL을 파싱한 후 해당 SQL이 라이브러리 캐시에 존재하지 않아 찾는 데 실패해 최적화 및 로우 소스 생성 단계까지 모두 거치는 것

#### 1.2.2 바인드 변수의 중요성
- 이름없는 SQL 문제
  - SQL은 따로 이름이 없음 
  - 전체 SQL 텍스트가 이름 역할을 함
  - 처음 실행할 때 최적화 과정을 거쳐 동적으로 생성한 내부 프로시저를 라이브러리 캐시에 적재함으로써 여러 사용자가 공유하면서 재사용함
  - 캐시 공간이 부족하면 버려졌다가 다음에 다시 실행할 때 똑같은 최적화 과정을 거쳐 캐시에 적재됨
  - SQL 자체가 이름이기 때문에 텍스트 중 작은 부분이라도 수정되면 그 순간 다른 객체가 새로 탄생하는 구조
  - DBMS에서 수행되는 SQL이 모두 완성된 것은 아니므로 모두 저장하면 많은 공간이 필요하고 SQL을 찾는 속도도 느려짐 -> 오라클 같은 DBMS가 SQL 영구 저장을 하지 않음
  - 공유가능 SQL
    - 프로시저를 여러 개 생성하는 것이 아니라 파라미터가 있는 프로시저 하나를 공유하면서 재사용 하는 것이 낫다
    - 파라미터 Driven 방식으로 SQL을 작성하는 방법이 제공됨 -> 바인드 변수
    - 하드파싱은 최초에 한번만 일어나고 캐싱된 SQL을 여러 사람이 공유하면서 재사용하게 됨

